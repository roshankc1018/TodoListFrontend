/**-----------------------------------------------------------------------------------------
* Copyright Â© 2021 Progress Software Corporation. All rights reserved.
* Licensed under commercial license. See LICENSE.md in the project root for more information
*-------------------------------------------------------------------------------------------*/
import * as tslib_1 from "tslib";
import { MenuTabbingService } from './../filtering/menu/menu-tabbing.service';
import { NavigationService } from './../navigation/navigation.service';
import { Component, Input, TemplateRef, HostBinding, ElementRef, ViewChild } from '@angular/core';
import { LocalizationService } from "@progress/kendo-angular-l10n";
import { SinglePopupService } from '../common/single-popup.service';
import { ColumnMenuService } from './column-menu.service';
import { filtersByField } from '../filtering/base-filter-cell.component';
import { hasFilter, hasSort, hasLock, hasStick, hasColumnChooser, hasPosition } from './utils';
import { replaceMessagePlaceholder } from '../utils';
var POPUP_CLASS = 'k-grid-columnmenu-popup';
/**
 * Represents the [column menu]({% slug columnmenu_grid %}) component.
 */
var ColumnMenuComponent = /** @class */ (function () {
    function ColumnMenuComponent(popupService, localization, service, navigationService) {
        this.popupService = popupService;
        this.localization = localization;
        this.service = service;
        this.navigationService = navigationService;
        /**
         * @hidden
         */
        this.standalone = true;
        /**
         * The settings for the Column Menu.
         */
        this.settings = {};
        /**
         * @hidden
         */
        this.sortable = true;
        /**
         * @hidden
         */
        this.tabIndex = '-1';
        /**
         * @hidden
         */
        this.expandedFilter = false;
        /**
         * @hidden
         */
        this.expandedColumns = false;
        /**
         * @hidden
         */
        this.expandedPosition = false;
        this.closeSubscription = service.closeMenu.subscribe(this.close.bind(this));
    }
    Object.defineProperty(ColumnMenuComponent.prototype, "isActive", {
        /**
         * @hidden
         */
        get: function () {
            var _this = this;
            return (this.hasFilter && filtersByField(this.filter, this.column.field).length > 0) ||
                (!this.sortable && this.hasSort && this.sort.find(function (descriptor) { return descriptor.field === _this.column.field; }));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ColumnMenuComponent.prototype, "hasFilter", {
        /**
         * @hidden
         */
        get: function () {
            return hasFilter(this.settings, this.column);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ColumnMenuComponent.prototype, "hasSort", {
        /**
         * @hidden
         */
        get: function () {
            return hasSort(this.settings, this.column);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ColumnMenuComponent.prototype, "hasColumnChooser", {
        /**
         * @hidden
         */
        get: function () {
            return hasColumnChooser(this.settings);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ColumnMenuComponent.prototype, "hasLock", {
        /**
         * @hidden
         */
        get: function () {
            return hasLock(this.settings, this.column);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ColumnMenuComponent.prototype, "hasStick", {
        /**
         * @hidden
         */
        get: function () {
            return hasStick(this.settings, this.column);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ColumnMenuComponent.prototype, "hasPosition", {
        /**
         * @hidden
         */
        get: function () {
            return hasPosition(this.settings, this.column);
        },
        enumerable: true,
        configurable: true
    });
    ColumnMenuComponent.prototype.ngOnChanges = function () {
        this.service.column = this.column;
        this.service.sort = this.sort;
        this.service.filter = this.filter;
        this.service.sortable = this.sortable;
    };
    ColumnMenuComponent.prototype.ngOnDestroy = function () {
        this.close();
        this.closeSubscription.unsubscribe();
    };
    /**
     * @hidden
     */
    ColumnMenuComponent.prototype.toggle = function (e, anchor, template) {
        if (e) {
            e.preventDefault();
            e.stopImmediatePropagation();
        }
        this.expandedFilter = this.getExpandedState(this.settings.filter);
        this.expandedColumns = this.getExpandedState(this.settings.columnChooser);
        this.expandedPosition = this.getExpandedState(this.settings.setColumnPosition);
        this.popupRef = this.popupService.open(anchor, template, this.popupRef, POPUP_CLASS);
        if (!this.popupRef) {
            if (this.navigationService.enabled) {
                this.navigationService.focusCell(0, this.column.leafIndex);
            }
            else {
                this.anchor.nativeElement.focus();
            }
        }
    };
    /**
     * @hidden
     */
    ColumnMenuComponent.prototype.close = function () {
        this.popupService.destroy();
        this.popupRef = null;
        if (this.navigationService.enabled) {
            this.navigationService.focusCell(0, this.column.leafIndex);
        }
        else {
            this.anchor.nativeElement.focus();
        }
    };
    Object.defineProperty(ColumnMenuComponent.prototype, "columnMenuTitle", {
        /**
         * @hidden
         */
        get: function () {
            var localizationMsg = this.localization.get('columnMenu') || '';
            var columnName = this.column.title || this.column.field;
            return replaceMessagePlaceholder(localizationMsg, 'columnName', columnName);
        },
        enumerable: true,
        configurable: true
    });
    ColumnMenuComponent.prototype.getExpandedState = function (menuItemSettings) {
        return typeof (menuItemSettings) === 'object' ? menuItemSettings.expanded : false;
    };
    tslib_1.__decorate([
        HostBinding('class.k-grid-column-menu-standalone'),
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], ColumnMenuComponent.prototype, "standalone", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], ColumnMenuComponent.prototype, "column", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], ColumnMenuComponent.prototype, "settings", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], ColumnMenuComponent.prototype, "sort", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], ColumnMenuComponent.prototype, "filter", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], ColumnMenuComponent.prototype, "sortable", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", TemplateRef)
    ], ColumnMenuComponent.prototype, "columnMenuTemplate", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], ColumnMenuComponent.prototype, "tabIndex", void 0);
    tslib_1.__decorate([
        ViewChild('anchor', { static: true }),
        tslib_1.__metadata("design:type", ElementRef)
    ], ColumnMenuComponent.prototype, "anchor", void 0);
    tslib_1.__decorate([
        ViewChild('template', { static: true, read: TemplateRef }),
        tslib_1.__metadata("design:type", TemplateRef)
    ], ColumnMenuComponent.prototype, "template", void 0);
    ColumnMenuComponent = tslib_1.__decorate([
        Component({
            providers: [
                ColumnMenuService,
                MenuTabbingService
            ],
            selector: 'kendo-grid-column-menu',
            template: "\n        <a #anchor\n            class=\"k-grid-column-menu k-grid-filter\"\n            [ngClass]=\"{ 'k-state-active': isActive }\"\n            (click)=\"toggle($event, anchor, template)\"\n            (keydown.enter)=\"$event.stopImmediatePropagation()\"\n            href=\"#\"\n            [tabindex]=\"tabIndex\"\n            [attr.title]=\"columnMenuTitle\">\n            <span class=\"k-icon k-i-more-vertical\"></span>\n        </a>\n        <ng-template #template>\n            <ng-container\n                [ngTemplateOutlet]=\"column.columnMenuTemplateRef || columnMenuTemplate || defaultTemplate\"\n                [ngTemplateOutletContext]=\"{ service: service, column: column }\">\n            </ng-container>\n        </ng-template>\n        <ng-template #defaultTemplate>\n            <kendo-grid-columnmenu-container\n                (keydown.escape)=\"close()\"\n                (keydown.enter)=\"$event.stopImmediatePropagation()\">\n                <kendo-grid-columnmenu-sort #sortItem [kendoGridColumnMenuItem]=\"sortItem\" *ngIf=\"hasSort\" [service]=\"service\">\n                </kendo-grid-columnmenu-sort>\n                <kendo-grid-columnmenu-lock #lockItem *ngIf=\"hasLock && !hasPosition\" [kendoGridColumnMenuItem]=\"lockItem\" [service]=\"service\">\n                </kendo-grid-columnmenu-lock>\n                <kendo-grid-columnmenu-stick #stickItem *ngIf=\"hasStick && !hasPosition\" [kendoGridColumnMenuItem]=\"stickItem\" [service]=\"service\">\n                </kendo-grid-columnmenu-stick>\n                <kendo-grid-columnmenu-position\n                    #positionItem\n                    *ngIf=\"hasPosition\"\n                    [showLock]=\"hasLock\"\n                    [showStick]=\"hasStick\"\n                    [kendoGridColumnMenuItem]=\"positionItem\"\n                    [service]=\"service\"\n                    [expanded]=\"expandedPosition\">\n                </kendo-grid-columnmenu-position>\n                <kendo-grid-columnmenu-chooser\n                    #chooserItem\n                    *ngIf=\"hasColumnChooser\"\n                    [kendoGridColumnMenuItem]=\"chooserItem\"\n                    [service]=\"service\"\n                    [expanded]=\"expandedColumns\">\n                </kendo-grid-columnmenu-chooser>\n                <kendo-grid-columnmenu-filter\n                    #filterItem\n                    *ngIf=\"hasFilter\"\n                    [kendoGridColumnMenuItem]=\"filterItem\"\n                    [service]=\"service\"\n                    [expanded]=\"expandedFilter\">\n                </kendo-grid-columnmenu-filter>\n            </kendo-grid-columnmenu-container>\n        </ng-template>\n    "
        }),
        tslib_1.__metadata("design:paramtypes", [SinglePopupService,
            LocalizationService,
            ColumnMenuService,
            NavigationService])
    ], ColumnMenuComponent);
    return ColumnMenuComponent;
}());
export { ColumnMenuComponent };
